- name: Install uwsgi and python and other dependencies
  apt: pkg=uwsgi,uwsgi-plugin-python3,virtualenv,python-pip,libpq-dev state=installed update_cache=true
  become: yes
  become_user: root

- name: Update git repo
  git:
    repo={{ git_repo }}
    dest={{ project_dir }}
    version=master
    accept_hostkey=True
  notify: reload uwsgi

- name: Create virtualenv and install dependencies
  pip: requirements={{ project_dir}}/requirements/base.txt virtualenv={{ root_dir }}/venv

- name: Create uwsgi config file
  template: src=default.ini dest=/etc/uwsgi/apps-available/default
  become: yes
  become_user: root
  notify: restart uwsgi

- name: Symlink uwsgi config file
  file: src=/etc/uwsgi/apps-available/default dest=/etc/uwsgi/apps-enabled/default state=link
  become: yes
  become_user: root
  notify: restart uwsgi

- name: Generate django config
  template: src=prod.py dest={{ project_dir }}/{{ project_name }}/settings/prod.py

- name: Generate config directory
  file: path={{ root_dir }}/config state=directory

- name: Check SECRET_KEY file stat
  stat: path={{ project_dir }}/envdir/SECRET_KEY
  register: secret_key_file

- name: Generate SECRET_KEY file if it does not exist yet
  shell: cat /dev/urandom | tr -dc "abcdefghijklmnopqrstuvwxyz0123456789!@#\$%^&*(-_=+)" | head -c 100 > {{ project_dir }}/envdir/SECRET_KEY
  when: not secret_key_file.stat.exists
